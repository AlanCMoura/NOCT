const handleEditSave = async () => {
    if (!draftDetail || !containerId || saving) return;

    setSaving(true);

    try {
      // 1. Atualizar dados do container
      const payload = {
        description: draftDetail.description?.trim() ?? "",
        sacksCount: Number(draftDetail.sacariaQuantity) || 0,
        tareTons: Number(draftDetail.tare) || 0,
        liquidWeight: Number(draftDetail.netWeight) || 0,
        grossWeight: Number(draftDetail.grossWeight) || 0,
        agencySeal: draftDetail.sealAgency?.trim() ?? "",
        otherSeals:
          draftDetail.otherSeals
            ?.split(",")
            .map((s) => s.trim())
            .filter((s) => s.length > 0) ?? [],
        status: mapStatusToApi(draftDetail.status ?? "Aberto"),
      };

      console.log("üì§ Atualizando container:", payload);

      const updateResponse = await authFetch(
        `${API_BASE_URL}/containers/${encodeURIComponent(containerId)}`,
        {
          method: "PUT",
          body: JSON.stringify(payload),
        }
      );

      if (!updateResponse.ok) {
        const errorText = await updateResponse.text();
        console.error("Erro ao atualizar container:", errorText);
        Alert.alert("Erro", `N√£o foi poss√≠vel salvar o container. ${errorText}`);
        return;
      }

      // 2. Upload de novas imagens (locais)
      const form = new FormData();
      let hasNewImages = false;

      draftDetail.photoSections.forEach((section) => {
        const sectionConfig = CATEGORY_SECTIONS.find((c) => c.id === section.id);
        if (!sectionConfig) return;

        const localImages = section.images.filter((uri) => isLocalUri(uri));

        localImages.forEach((uri, idx) => {
          const filename = `${sectionConfig.uploadField}_${idx}_${Date.now()}.jpg`;
          form.append(sectionConfig.uploadField, {
            uri,
            name: filename,
            type: "image/jpeg",
          } as any);
          hasNewImages = true;
        });
      });

      if (hasNewImages) {
        console.log("üì§ Enviando novas imagens...");

        const uploadResponse = await authFetch(
          `${API_BASE_URL}/containers/${encodeURIComponent(containerId)}/images`,
          {
            method: "POST",
            body: form,
          }
        );

        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          console.warn("Aviso: Falha ao enviar algumas imagens:", errorText);
          // N√£o interrompe o fluxo, apenas avisa
        } else {
          console.log("‚úÖ Imagens enviadas com sucesso");
        }
      }

      // 3. Recarregar dados atualizados
      await fetchContainerDetail(containerId);

      Alert.alert("Sucesso", hasNewImages ? "Container e imagens atualizados." : "Container atualizado.");
    } catch (err) {
      console.error("Erro ao salvar container:", err);
      Alert.alert("Erro", "N√£o foi poss√≠vel salvar o container.");
    } finally {
      setSaving(false);
    }
  };

  // Excluir container
  const handleDeletePress = () => {
    if (isCreateMode || !displayDetail || !containerId) return;

    Alert.alert(
      "Excluir container",
      `Tem certeza que deseja excluir o container "${displayDetail.code}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`,
      [
        { text: "Cancelar", style: "cancel" },
        {
          text: "Excluir",
          style: "destructive",
          onPress: handleConfirmDelete,
        },
      ]
    );
  };

  const handleConfirmDelete = async () => {
    if (!containerId || deleting) return;

    setDeleting(true);

    try {
      console.log("üóëÔ∏è Excluindo container:", containerId);

      const response = await authFetch(
        `${API_BASE_URL}/containers/${encodeURIComponent(containerId)}`,
        { method: "DELETE" }
      );

      if (!response.ok && response.status !== 204) {
        const errorText = await response.text();
        console.error("Erro ao excluir container:", errorText);
        Alert.alert("Erro", "N√£o foi poss√≠vel excluir o container.");
        return;
      }

      console.log("‚úÖ Container exclu√≠do com sucesso");
      Alert.alert("Sucesso", "Container exclu√≠do com sucesso.", [
        { text: "OK", onPress: () => router.back() },
      ]);
    } catch (err) {
      console.error("Erro ao excluir container:", err);
      Alert.alert("Erro", "N√£o foi poss√≠vel excluir o container.");
    } finally {
      setDeleting(false);
    }
  };

  // Finalizar container (mudar status para COMPLETED)
  const handleCompleteContainer = () => {
    if (!containerId || isContainerCompleted) return;

    Alert.alert(
      "Finalizar container",
      "Tem certeza que deseja finalizar este container?\n\nAp√≥s finalizado, n√£o ser√° poss√≠vel editar.",
      [
        { text: "Cancelar", style: "cancel" },
        {
          text: "Finalizar",
          onPress: handleConfirmComplete,
        },
      ]
    );
  };

  const handleConfirmComplete = async () => {
    if (!containerId || saving) return;

    setSaving(true);

    try {
      console.log("‚úÖ Finalizando container:", containerId);

      const response = await authFetch(
        `${API_BASE_URL}/containers/${encodeURIComponent(containerId)}/status`,
        { method: "PATCH" }
      );

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Erro ao finalizar container:", errorText);
        Alert.alert("Erro", `N√£o foi poss√≠vel finalizar o container.\n${errorText}`);
        return;
      }

      await fetchContainerDetail(containerId);
      Alert.alert("Sucesso", "Container finalizado com sucesso.");
    } catch (err) {
      console.error("Erro ao finalizar container:", err);
      Alert.alert("Erro", "N√£o foi poss√≠vel finalizar o container.");
    } finally {
      setSaving(false);
    }
  };

  // Renderiza√ß√£o de estados de loading/erro
  if (!displayDetail) {
    if (isCreateMode) {
      return (
        <SafeAreaView className="flex-1" style={{ backgroundColor: "#F6F8FB" }}>
          <CustomStatusBar backgroundColor="#F6F8FB" barStyle="dark-content" translucent />
          <View className="flex-1 items-center justify-center px-6">
            <ActivityIndicator size="large" color="#49C5B6" />
            <Text style={{ marginTop: 12, color: "#2A2E40" }}>Preparando cria√ß√£o do container...</Text>
          </View>
        </SafeAreaView>
      );
    }

    return (
      <SafeAreaView className="flex-1" style={{ backgroundColor: "#F6F8FB" }}>
        <CustomStatusBar backgroundColor="#F6F8FB" barStyle="dark-content" translucent />
        <View className="flex-1 items-center justify-center px-6">
          {loading ? (
            <>
              <ActivityIndicator size="large" color="#49C5B6" />
              <Text style={{ marginTop: 12, color: "#2A2E40" }}>Carregando container...</Text>
            </>
          ) : (
            <>
              <Text style={styles.missingTitle}>{error || "Container n√£o encontrado"}</Text>
              <Text style={[styles.missingSubtitle, { textAlign: "center", marginTop: 8 }]}>
                Verifique se o identificador informado est√° correto ou selecione outro container.
              </Text>
            </>
          )}
          <TouchableOpacity
            style={[styles.actionButton, styles.cancelButton, { marginTop: 24 }]}
            onPress={() => router.back()}
          >
            <Text style={[styles.actionButtonLabel, styles.cancelButtonText]}>Voltar</Text>
          </TouchableOpacity>
        </View>
      </SafeAreaView>
    );
  }

  // Campos de informa√ß√£o
  const infoFields: InfoField[] = [
    {
      key: "code",
      label: "Identifica√ß√£o",
      value: isEditing ? draftDetail?.code ?? "" : displayDetail.code ?? "-",
      editable: false, // ID n√£o √© edit√°vel
      placeholder: "Identificador",
    },
    {
      key: "description",
      label: "Descri√ß√£o",
      value: isEditing ? draftDetail?.description ?? "" : displayDetail.description ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("description", value) : undefined,
      placeholder: "Descri√ß√£o do container",
    },
    {
      key: "sacariaQuantity",
      label: "Quantidade de Sacas",
      value: isEditing ? draftDetail?.sacariaQuantity ?? "" : displayDetail.sacariaQuantity ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("sacariaQuantity", value) : undefined,
      placeholder: "Ex: 300",
      keyboardType: "numeric",
    },
    {
      key: "tare",
      label: "Tara (ton)",
      value: isEditing ? draftDetail?.tare ?? "" : displayDetail.tare ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("tare", value) : undefined,
      placeholder: "Ex: 2.5",
      keyboardType: "numeric",
    },
    {
      key: "netWeight",
      label: "Peso L√≠quido (ton)",
      value: isEditing ? draftDetail?.netWeight ?? "" : displayDetail.netWeight ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("netWeight", value) : undefined,
      placeholder: "Ex: 25.0",
      keyboardType: "numeric",
    },
    {
      key: "grossWeight",
      label: "Peso Bruto (ton)",
      value: isEditing ? draftDetail?.grossWeight ?? "" : displayDetail.grossWeight ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("grossWeight", value) : undefined,
      placeholder: "Ex: 27.5",
      keyboardType: "numeric",
    },
    {
      key: "sealAgency",
      label: "Lacre Principal (ag√™ncia)",
      value: isEditing ? draftDetail?.sealAgency ?? "" : displayDetail.sealAgency ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("sealAgency", value) : undefined,
      placeholder: "C√≥digo do lacre",
    },
    {
      key: "otherSeals",
      label: "Outros Lacres",
      value: isEditing ? draftDetail?.otherSeals ?? "" : displayDetail.otherSeals ?? "-",
      editable: isEditing,
      onChange: isEditing ? (value: string) => updateDraft("otherSeals", value) : undefined,
      placeholder: "Ex: LAC1002, LAC1003",
    },
  ];

  const leftColumnKeys: Array<InfoField["key"]> = ["code", "tare", "sealAgency", "otherSeals"];
  const columns = [
    infoFields.filter((field) => leftColumnKeys.includes(field.key)),
    infoFields.filter((field) => !leftColumnKeys.includes(field.key)),
  ];

  const headerPaddingTop = Math.max(insets.top, 12) + 12;
  const slideWidth = Math.max((SCREEN_WIDTH - CAROUSEL_ITEM_SPACING) / 1.5, 220);
  const snapInterval = slideWidth + CAROUSEL_ITEM_SPACING;

  return (
    <SafeAreaView className="flex-1" style={{ backgroundColor: "#F6F8FB" }}>
      <CustomStatusBar backgroundColor="#F6F8FB" barStyle="dark-content" translucent />
      <View className="flex-1">
        {/* Header */}
        <View
          className="w-full px-6 pb-4"
          style={[styles.headerContainer, { paddingTop: headerPaddingTop }]}
        >
          <View style={styles.headerTopRow}>
            <View style={styles.headerLeft}>
              <TouchableOpacity
                className="p-2"
                activeOpacity={0.7}
                onPress={() => router.back()}
                style={styles.iconButton}
              >
                <Svg width={22} height={22} viewBox="0 0 24 24" fill="none">
                  <Path
                    d="M15 18l-6-6 6-6"
                    stroke="#2A2E40"
                    strokeWidth={1.8}
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </Svg>
              </TouchableOpacity>
              <View style={styles.titleWrapper}>
                <Text style={styles.mainTitle} numberOfLines={1}>
                  {displayDetail?.code || "Container"}
                </Text>
                <Text style={styles.subtitle} numberOfLines={1}>
                  Opera√ß√£o {displayDetail?.operationCode || "-"}
                </Text>
              </View>
            </View>
            <View style={[styles.statusChip, { backgroundColor: statusInfo.background }]}>
              <Text style={[styles.statusChipText, { color: statusInfo.color }]}>
                {statusInfo.label}
              </Text>
            </View>
          </View>

          {/* Bot√µes de a√ß√£o */}
          <View style={styles.headerActions}>
            {isEditing ? (
              <>
                <TouchableOpacity
                  style={[styles.actionButton, styles.cancelButton, saving && styles.buttonDisabled]}
                  onPress={handleEditCancel}
                  activeOpacity={0.8}
                  disabled={saving}
                >
                  <Text style={[styles.actionButtonLabel, styles.cancelButtonText]}>Cancelar</Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={[styles.actionButton, styles.editButton, saving && styles.buttonDisabled]}
                  onPress={handleEditSave}
                  activeOpacity={0.85}
                  disabled={saving}
                >
                  {saving ? (
                    <View style={styles.savingRow}>
                      <ActivityIndicator size="small" color="#FFFFFF" />
                      <Text style={[styles.actionButtonLabel, styles.editButtonText, { marginLeft: 8 }]}>
                        Salvando...
                      </Text>
                    </View>
                  ) : (
                    <Text style={[styles.actionButtonLabel, styles.editButtonText]}>Salvar</Text>
                  )}
                </TouchableOpacity>
              </>
            ) : (
              <>
                {!isContainerCompleted && (
                  <TouchableOpacity
                    style={[styles.actionButton, styles.editButton]}
                    onPress={handleEditPress}
                    activeOpacity={0.8}
                  >
                    <Text style={[styles.actionButtonLabel, styles.editButtonText]}>Editar</Text>
                  </TouchableOpacity>
                )}
                <TouchableOpacity
                  style={[styles.actionButton, styles.deleteButton, deleting && styles.buttonDisabled]}
                  onPress={handleDeletePress}
                  activeOpacity={0.8}
                  disabled={deleting}
                >
                  {deleting ? (
                    <ActivityIndicator size="small" color="#B91C1C" />
                  ) : (
                    <Text style={[styles.actionButtonLabel, styles.deleteButtonText]}>Excluir</Text>
                  )}
                </TouchableOpacity>
              </>
            )}
          </View>
        </View>

        {/* Conte√∫do */}
        <ScrollView
          className="flex-1"
          showsVerticalScrollIndicator={false}
          contentContainerStyle={styles.contentContainer}
        >
          {/* Card de dados do container */}
          <View style={styles.card}>
            <View style={styles.cardHeader}>
              <Text style={styles.cardTitle}>Dados do Container</Text>
              {!isEditing && (
                <View style={styles.switchWrapper}>
                  <Switch
                    trackColor={{ false: "#CBD5E1", true: "#49C5B6" }}
                    thumbColor="#FFFFFF"
                    value={!!isContainerCompleted}
                    onValueChange={handleCompleteToggle}
                    disabled={isContainerCompleted || saving}
                  />
                  <Text style={styles.switchLabel}>Completo</Text>
                </View>
              )}
            </View>

            {/* Seletor de status (modo edi√ß√£o) */}
            {isEditing && (
              <View style={styles.statusEditor}>
                <Text style={styles.editLabel}>Status do container</Text>
                <View style={styles.statusOptions}>
                  {STATUS_OPTIONS.map((status) => {
                    const isActive = draftDetail?.status === status;
                    return (
                      <TouchableOpacity
                        key={status}
                        style={[styles.statusOption, isActive && styles.statusOptionActive]}
                        onPress={() => updateDraft("status", status)}
                        activeOpacity={0.85}
                      >
                        <Text
                          style={[styles.statusOptionText, isActive && styles.statusOptionTextActive]}
                        >
                          {STATUS_MAP[status].label}
                        </Text>
                      </TouchableOpacity>
                    );
                  })}
                </View>
              </View>
            )}

            {/* Grid de informa√ß√µes */}
            <View style={styles.infoGrid}>
              {columns.map((columnFields, columnIndex) => (
                <View key={`column-${columnIndex}`} style={styles.infoGridColumn}>
                  {columnFields.map((field) => (
                    <InfoColumn
                      key={field.key}
                      label={field.label}
                      value={field.value}
                      editable={field.editable}
                      onChange={field.onChange}
                      placeholder={field.placeholder}
                      keyboardType={field.keyboardType}
                      containerStyle={styles.infoGridField}
                    />
                  ))}
                </View>
              ))}
            </View>
          </View>

          {/* Se√ß√µes de fotos */}
          {displayDetail.photoSections.map((section) => {
            const count = section.images.length;
            return (
              <View key={section.id} style={styles.carouselCard}>
                <View style={styles.carouselHeader}>
                  <Text style={styles.carouselTitle}>{section.title}</Text>
                  {!isEditing && (
                    <Text style={styles.carouselCount}>
                      {count} {count === 1 ? "imagem" : "imagens"}
                    </Text>
                  )}
                </View>

                {isEditing ? (
                  <View style={styles.imageEditor}>
                    {section.images.length > 0 ? (
                      section.images.map((image, index) => (
                        <View key={`${section.id}-image-${index}`} style={styles.imageRow}>
                          <Image
                            source={{ uri: image }}
                            style={styles.imageThumbnail}
                            resizeMode="cover"
                          />
                          <View style={styles.imageInfo}>
                            <Text style={styles.imageLabel} numberOfLines={1}>
                              {isLocalUri(image) ? "Nova imagem" : `Imagem ${index + 1}`}
                            </Text>
                            {isLocalUri(image) && (
                              <Text style={styles.imagePending}>Pendente de upload</Text>
                            )}
                          </View>
                          <View style={styles.imageActions}>
                            <TouchableOpacity
                              style={[styles.imageActionButton, styles.imageActionDanger]}
                              onPress={() => handleRemoveImage(section.id, index)}
                              activeOpacity={0.75}
                            >
                              <Text style={styles.imageActionDangerText}>Remover</Text>
                            </TouchableOpacity>
                          </View>
                        </View>
                      ))
                    ) : (
                      <Text style={styles.imageEmptyText}>Nenhuma imagem anexada ainda.</Text>
                    )}
                    <View style={styles.imageFooterActions}>
                      <TouchableOpacity
                        style={styles.imageActionButton}
                        onPress={() =>
                          promptImageSource("Adicionar imagem", (source) =>
                            handleAttachImage(section.id, source)
                          )
                        }
                        activeOpacity={0.85}
                      >
                        <Text style={styles.imageActionText}>Adicionar imagem</Text>
                      </TouchableOpacity>
                    </View>
                  </View>
                ) : count > 0 ? (
                  <FlatList
                    data={section.images}
                    keyExtractor={(item, index) => `${section.id}-${index}`}
                    horizontal
                    showsHorizontalScrollIndicator={false}
                    snapToAlignment="start"
                    decelerationRate="fast"
                    snapToInterval={snapInterval}
                    contentContainerStyle={[
                      styles.carouselContent,
                      { paddingHorizontal: CAROUSEL_ITEM_SPACING },
                    ]}
                    ItemSeparatorComponent={() => <View style={{ width: CAROUSEL_ITEM_SPACING }} />}
                    renderItem={({ item }) => (
                      <View style={[styles.carouselSlide, { width: slideWidth }]}>
                        <Image source={{ uri: item }} style={styles.carouselImage} resizeMode="cover" />
                      </View>
                    )}
                  />
                ) : (
                  <View style={styles.carouselEmpty}>
                    <Text style={styles.carouselEmptyTitle}>Sem imagens</Text>
                    <Text style={styles.carouselEmptySubtitle}>
                      {isContainerCompleted
                        ? "Nenhuma imagem registrada para esta etapa."
                        : "Clique em Editar para adicionar imagens."}
                    </Text>
                  </View>
                )}
              </View>
            );
          })}
        </ScrollView>
      </View>
    </SafeAreaView>
  );
};

// Componente de campo de informa√ß√£o

